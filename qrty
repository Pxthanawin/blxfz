-- ============== MERGED SYSTEM (SMART HOP + API) ==============
task.spawn(function()
    -- Configuration
    local SERVER_IP = "pptnw.3bbddns.com"
    local SERVER_PORT = 14421
    local HEARTBEAT_INTERVAL = 3
    local HOP_CHECK_INTERVAL = 20     -- เช็คเซิร์ฟเวอร์ซ้ำทุก 20 วินาที
    local MAX_HOP_ATTEMPTS = 5
    local HOP_RETRY_DELAY = 5

    -- Services
    local HttpService = game:GetService("HttpService")
    local Players = game:GetService("Players")
    local RunService = game:GetService("RunService")
    local GuiService = game:GetService("GuiService")
    local TeleportService = game:GetService("TeleportService")

    -- State
    local isSystemActive = true
    local lastHeartbeatSent = 0
    local lastHopCheck = 0
    local hopAttempts = 0
    local hasSentSuccess = false
    local failedJobIds = {}

    -- URLs
    local BASE_API_URL = string.format("http://%s:%d", SERVER_IP, SERVER_PORT)
    local HEARTBEAT_URL = BASE_API_URL .. "/heartbeat"
    local STATUS_URL = BASE_API_URL .. "/status"
    local ROBLOX_API_BASE_URL = "https://games.roblox.com/v1/games/" .. tostring(game.PlaceId) .. "/servers/Public?sortOrder=Asc&excludeFullGames=true&limit=100"

    -- Wait for Player
    repeat task.wait() until Players.LocalPlayer
    local LocalPlayer = Players.LocalPlayer

    -- Character Load Timeout Logic
    local characterLoadTimeout = 75
    task.spawn(function()
        if not characterLoadTimeout then return end
        characterLoadTimeout = ((characterLoadTimeout == true) and 60) or characterLoadTimeout
        repeat task.wait(0.25) until LocalPlayer.Character or time() > characterLoadTimeout
        if not LocalPlayer.Character then 
            -- isSystemActive = false -- (Optional)
        end
    end)

    -- Helper: Stop System
    local function stopSystem(reason)
        if not isSystemActive then return end
        isSystemActive = false
        print(string.format("System: Stopping. Reason: %s", reason))
    end

    -- Helper: Find Max User ID (Leader Election)
    local function findMaxUserId(tbl)
        local max = -1
        for _, value in ipairs(tbl) do
            if value > max then max = value end
        end
        return max
    end

    -- Helper: Success Condition (Customize as needed)
    local function success()
        return false -- ใส่เงื่อนไขเช็คความสำเร็จที่นี่
    end

    -- API: Get All Statuses
    local function getAllStatuses()
        local success, response = pcall(http_request, { Url = STATUS_URL, Method = "GET" })
        if not success or not response or not response.Success then
            warn("SmartHop: Failed to get statuses from server.")
            return nil
        end
        local decodeSuccess, decodedData = pcall(HttpService.JSONDecode, HttpService, response.Body)
        return (decodeSuccess and decodedData) and decodedData.data or nil
    end

    -- Logic: Find and Hop
    local function findAndHopToUniqueServer(allStatuses, jobIdsToExclude)
        if not isSystemActive then return end
        hopAttempts = hopAttempts + 1
        print(string.format("SmartHop: Attempt #%d to find a new server...", hopAttempts))
        
        local claimedJobIds = {}
        if allStatuses then
            for _, userData in ipairs(allStatuses) do
                if userData.extraData and userData.extraData.jobId then
                    claimedJobIds[userData.extraData.jobId] = true
                end
            end
        end

        local potentialServers = {}
        local success, response = pcall(game.HttpGet, game, ROBLOX_API_BASE_URL, true)

        if success and response then
            local decodeSuccess, pageData = pcall(HttpService.JSONDecode, HttpService, response)
            if decodeSuccess and pageData.data then
                for _, serverData in ipairs(pageData.data) do
                    if not claimedJobIds[serverData.id] and not jobIdsToExclude[serverData.id] and serverData.id ~= game.JobId and serverData.playing < serverData.maxPlayers then
                        table.insert(potentialServers, serverData)
                    end
                end
            end
        end

        if #potentialServers > 0 then
            local targetServer = potentialServers[math.random(1, #potentialServers)]
            print(string.format("SmartHop: Teleporting to server with %d players.", targetServer.playing))
            stopSystem("Teleporting to new server")
            TeleportService:TeleportToPlaceInstance(game.PlaceId, targetServer.id, LocalPlayer)
        else
            print("SmartHop: No unique server found. Retrying standard hop...")
            local PlaceId, JobId = game.PlaceId, game.JobId
            TeleportService:Teleport(PlaceId, LocalPlayer)
        end
    end

    -- Logic: Check Duplicates
    local function checkForAndResolveDuplicates()
        if not isSystemActive then return end

        local allStatuses = getAllStatuses()
        if not allStatuses then return end

        local duplicatesInMyServer = { LocalPlayer.UserId }
        for _, userData in ipairs(allStatuses) do
            if userData.userId ~= LocalPlayer.UserId and userData.extraData and userData.extraData.jobId == game.JobId then
                table.insert(duplicatesInMyServer, userData.userId)
            end
        end

        if #duplicatesInMyServer > 1 then
            local leaderId = findMaxUserId(duplicatesInMyServer)
            print(string.format("SmartHop: Duplicate detected (%d users). Leader: %d", #duplicatesInMyServer, leaderId))
            
            if LocalPlayer.UserId == leaderId then
                print("SmartHop: I am the leader. I will hop to find a free server.")
                findAndHopToUniqueServer(allStatuses, failedJobIds)
            else
                print("SmartHop: I am not the leader. I will stay.")
            end
        end
    end

    -- Logic: Send Heartbeat
    local function sendHeartbeat()
        if not isSystemActive or (tick() - lastHeartbeatSent < HEARTBEAT_INTERVAL) then return end
        lastHeartbeatSent = tick()

        -- Check Success
        local shouldReportSuccess = hasSentSuccess
        if not shouldReportSuccess then
            local ok, result = pcall(success)
            if ok and result then
                hasSentSuccess = true
                shouldReportSuccess = true
            end
        end

        -- Prepare Payload
        local payload = {
            userId = LocalPlayer.UserId,
            jobId = game.JobId,
            placeId = game.PlaceId,
            playerName = LocalPlayer.Name,
            success = shouldReportSuccess
        }

        task.spawn(function()
            pcall(http_request, {
                Url = HEARTBEAT_URL,
                Method = "POST",
                Headers = { ["Content-Type"] = "application/json" },
                Body = HttpService:JSONEncode(payload)
            })
        end)
    end

    -- Event Handlers
    
    -- [[ ErrorMessageChanged แบบเก่า (ตามสคริปต์ API เดิม) ]] --
    GuiService.ErrorMessageChanged:Connect(function()
        task.wait(0.2)
        local errorEnum = GuiService:GetErrorCode()
        local errorCode = errorEnum and errorEnum.Value or 0

        if errorCode >= Enum.ConnectionError.DisconnectErrors.Value
            and errorCode <= Enum.ConnectionError.PlacelaunchOtherError.Value then

            local errorName = "Unknown"
            if errorEnum then
                errorName = errorEnum.Name
            else
                for _, enumItem in ipairs(Enum.ConnectionError:GetEnumItems()) do
                    if enumItem.Value == errorCode then
                        errorName = enumItem.Name
                        break
                    end
                end
            end

            stopSystem(string.format("Game Disconnect Error (%d: %s)", errorCode, errorName))
            task.delay(1, function()
                game:Shutdown()
            end)
        end
    end)
    -- [[ จบส่วน ErrorMessageChanged แบบเก่า ]] --

    TeleportService.TeleportInitFailed:Connect(function(player, teleportResult, errorMessage, placeId, jobId)
        if player ~= LocalPlayer then return end
        isSystemActive = true 
        warn("SmartHop: Teleport failed: " .. errorMessage)
        if jobId then failedJobIds[jobId] = true end
        
        task.wait(HOP_RETRY_DELAY)
        local statuses = getAllStatuses()
        findAndHopToUniqueServer(statuses or {}, failedJobIds)
    end)

    LocalPlayer.OnTeleport:Connect(function(state)
        if state == Enum.TeleportState.Started then stopSystem("Teleport Started") end
    end)

    -- Initial Check
    print(string.format("System: Activated for %s", LocalPlayer.Name))
    task.spawn(checkForAndResolveDuplicates)

    -- Main Loop
    RunService.Heartbeat:Connect(function()
        if not isSystemActive then return end
        
        sendHeartbeat()

        if (tick() - lastHopCheck > HOP_CHECK_INTERVAL) then
            lastHopCheck = tick()
            task.spawn(checkForAndResolveDuplicates)
        end
    end)
end)

-- ===========================================
-- ส่วนด้านล่างคือ Script เกมเดิมของคุณ (ไม่เปลี่ยนแปลง)
-- ===========================================

local RunService = game:GetService("RunService")
--[[
task.spawn(function()
    while task.wait(3) do
        RunService:Set3dRenderingEnabled(true)
        task.wait(0.1)
        RunService:Set3dRenderingEnabled(false)
    end
end)]]

repeat task.wait() until game:IsLoaded()
repeat task.wait() until game.Players
repeat task.wait() until game.Players.LocalPlayer
repeat task.wait() until game.Players.LocalPlayer:FindFirstChild("PlayerGui")
task.wait(5)

local run_quarty = {}

local banana_keys = {
    ['PC-240'] = "5cd825159627a0b9e858406a",
    ['PC-250'] = "2daa0763af6a2a7b31c247ee", --pp
    ['PC-260'] = "d94fc3686c260ead72afe0ee",
    ['PC-270'] = "8ff0e266d9e99c03b29aefa4",
    ['PC-290'] = "ec2879826d5e6831b1d973ae",
    ['PC-300'] = "7832599e58fa2ff3bc6f4cc8", --
    ['PC-310'] = "bde4df67d32723790652fca5",
    ['PC-320'] = "a62e7e044cc6801cde22047e",
    ['PC-330'] = "4961bad421f4f21e14d8d0e9",
    ['PC-340'] = "d315e33ed33c7a5a66346871", --t
    ['PC-350'] = "44a94c9b1352d82e62481fca", --t
    ['PC-360'] = "7ae7da9c819aec02114e577e", --t
    ['PC-370'] = "53f90f1032025bcac2d89daa",
    ['PC-380'] = "bc664e84da988dfa89adfb74",
    ['PC-390'] = "1dc7942fc904eba807d46b62",
}

task.spawn(function()
    task.wait(50)
    pcall(function()
        local data_load = game:GetService("Players").LocalPlayer.Character
        if not data_load then
            local c
            for i=1, 10 do
                task.wait(1)
                c = game:GetService("Players").LocalPlayer.Character
            end
            if not c then
                return
            end
        end
        while task.wait() do
            pcall(function()
                local Data = game:GetService("Players").LocalPlayer.Data
                if Data and Data.Beli then
                    _G.startm = Data.Beli.Value
                    task.wait(600)
                    if _G.startm == Data.Beli.Value then
                        game:Shutdown()
                    end
                end
            end)
        end
    end)
    game:Shutdown()
end)

if PC_NAME then
    getgenv().Hermanos_Settings = {
        ['key'] = '7e7b6686-593d-4306-bd3c-af5dfcab1010',
        ['PC'] = PC_NAME,

        ['webhooks'] = {
            ['fullmoon'] = 'https://discord.com/api/webhooks/',
            ['mirage'] = 'https://discord.com/api/webhooks/',
        },
        ['Sword'] = {'Cursed Dual Katana', 'Shark Anchor', 'Tushita', 'Yama', 'Dark Dagger', 'Hallow Scythe', 'Saber'},
        ['Gun'] = {'Soul Guitar', 'Serpent Bow', 'Kabucha', 'Acidum Rifle'},
        ['Accessories'] = {'Dark Coat', 'Leviathan Shield', 'Leviathan Crown', 'Pale Scarf', 'Kitsune Mask', 'Kitsune Ribbon'},
        ['Fruit'] = {
            'Kitsune', 'Tiger', 'Dragon (West)', 'Spirit', 'Control', 'Venom', 'Gas', 'Yeti',
            'Shadow', 'Dough', 'Mammoth', 'T-Rex', 'Dragon (East)', 'Lightning', 'Gravity', 'Pain', 'Sadness Pain', 'Torment Pain', 'Frustration Pain'
        }
    }

    task.spawn(function() loadstring(game:HttpGet('https://raw.githubusercontent.com/hermanos-dev/hermanos-script/main/main.lua'))() end)
end

if run_quarty[PC_NAME] then
    getgenv().Mode = "OneClick"
    getgenv().Setting = {
        ["Team"] = "Pirates", -- Options "Pirates", "Marines"
        ["FucusOnLevel"] = true,
        ["Fruits"] = {  -- setting for fruits u want
            ["Primary"] = { -- if current fruit is not in this list, eat/buy
                "Dough-Dough",
                -- u can configs add mores/remove and must end with , (comma symbol)
            },
            ["Normal"] = {
                "Light-Light",
                "Magma-Magma",
                "Ice-Ice",
                "Dark-Dark",
                -- u can configs add mores/remove and must end with , (comma symbol)
            }
            -- run this for get all fruit name `local t={};for _,v in pairs(game.ReplicatedStorage.Remotes.CommF_:InvokeServer("GetFruits"))do table.insert(t,v.Name)end;setclipboard(table.concat(t, "\n"))`
        },
        ["Lock Fruits"] = { -- don't use or eat fruits in this list
            [1] = "T-Rex-T-Rex",
            [2] = "Dough-Dough",
            [3] = "Dragon-Dragon",
            [4] = "Kitsune-Kitsune",
            [5] = "Mammoth-Mammoth",
            [6] = "Tiger-Tiger",
            [7] = "Gas-Gas",
            [8] = "Yeti-Yeti",
            [9] = "Gravity-Gravity",
            [10] = "Shadow-Shadow",
            [11] = "Venom-Venom",
            [12] = "Control-Control",
            [13] = "Spirit-Spirit",
        },
        ["IdleCheck"] = 300, -- every (x) seconds if not moving rejoin
    };
    getgenv().user_key = 'a80ba37569f39e5af83b57d147eb2da6'
    loadstring(game:HttpGet("https://raw.githubusercontent.com/xQuartyx/QuartyzScript/main/OneClick/BF.lua"))()
elseif banana_keys[PC_NAME] then
    getgenv().Key = banana_keys[PC_NAME]
    getgenv().SettingFarm ={
        ["Hide UI"] = false,
        ["Reset Teleport"] = {
            ["Enabled"] = false,
            ["Delay Reset"] = 3,
            ["Item Dont Reset"] = {
                ["Fruit"] = {
                    ["Enabled"] = true,
                    ["All Fruit"] = true,
                    ["Select Fruit"] = {
                        ["Enabled"] = false,
                        ["Fruit"] = {},
                    },
                },
            },
        },
        ["White Screen"] = false,
        ["Lock Fps"] = {
            ["Enabled"] = false,
            ["FPS"] = 12,
        },
        ["Get Items"] = {
            ["Saber"] = true,
            ["Godhuman"] =  true,
            ["Skull Guitar"] = false,
            ["Mirror Fractal"] = true,
            ["Cursed Dual Katana"] = true,
            ["Upgrade Race V2-V3"] = true,
            ["Auto Pull Lever"] = true,
            ["Shark Anchor"] = false,
        },
        ["Get Rare Items"] = {
            ["Rengoku"] = false,
            ["Dragon Trident"] = false,
            ["Pole (1st Form)"] = false,
            ["Gravity Blade"]  = false,
        },
        ["Farm Fragments"] = {
            ["Enabled"]  = true,
            ["Fragment"] = 50000,
        },
        ["Auto Chat"] = {
            ["Enabled"] = false,
            ["Text"] = "SirMadri - Dominando o mercado.",
        },
        ["Auto Summon Rip Indra"] = true,
        ["Select Hop"] = {
            ["Hop Server If Have Player Near"] = false,
            ["Hop Find Rip Indra Get Valkyrie Helm or Get Tushita"] = true,
            ["Hop Find Dough King Get Mirror Fractal"] = false,
            ["Hop Find Raids Castle [CDK]"] = false,
            ["Hop Find Cake Queen [CDK]"] = false,
            ["Hop Find Soul Reaper [CDK]"] = false,
            ["Hop Find Darkbeard [SG]"] = false,
            ["Hop Find Mirage [ Pull Lever ]"] = false,
        },
        ["Farm Mastery"] = {
            ["Melee"] = false,
            ["Sword"] = false,
        },
        ["Buy Haki"] = {
            ["Enhancement"] = true,
            ["Skyjump"] = true,
            ["Flash Step"] = true,
            ["Observation"] = true,
        },
        ["Sniper Fruit Shop"] = {
            ["Enabled"] = true,
            ["Fruit"] = {"Tiger-Tiger","Kitsune-Kitsune","Dragon-Dragon","Yeti-Yeti","Gas-Gas"},
        },
        ["Lock Fruits"] = {
            [1] = "T-Rex-T-Rex",
            [2] = "Dough-Dough",
            [3] = "Dragon-Dragon",
            [4] = "Kitsune-Kitsune",
            [5] = "Mammoth-Mammoth",
            [6] = "Tiger-Tiger",
            [7] = "Gas-Gas",
            [8] = "Yeti-Yeti",
            [9] = "Gravity-Gravity",
            [10] = "Shadow-Shadow",
            [11] = "Venom-Venom",
            [12] = "Control-Control",
            [13] = "Spirit-Spirit",
        },
        ["Webhook"] = {
            ["Enabled"] = false,
            ["WebhookUrl"] = "",
        }
    }
    loadstring(game:HttpGet("https://raw.githubusercontent.com/obiiyeuem/vthangsitink/main/BananaCat-kaitunBF.lua"))()
else
    getgenv().Mode = "OneClick"
    getgenv().Setting = {
        ["Team"] = "Pirates", -- Options "Pirates", "Marines"
        ["FucusOnLevel"] = true,
        ["Fruits"] = {  -- setting for fruits u want
            ["Primary"] = { -- if current fruit is not in this list, eat/buy
                "Dough-Dough",
                -- u can configs add mores/remove and must end with , (comma symbol)
            },
            ["Normal"] = {
                "Light-Light",
                "Magma-Magma",
                "Ice-Ice",
                "Dark-Dark",
                -- u can configs add mores/remove and must end with , (comma symbol)
            }
            -- run this for get all fruit name `local t={};for _,v in pairs(game.ReplicatedStorage.Remotes.CommF_:InvokeServer("GetFruits"))do table.insert(t,v.Name)end;setclipboard(table.concat(t, "\n"))`
        },
        ["Lock Fruits"] = { -- don't use or eat fruits in this list
            [1] = "T-Rex-T-Rex",
            --[2] = "Dough-Dough",
            [2] = "Dragon-Dragon",
            [3] = "Dragon-Dragon",
            [4] = "Kitsune-Kitsune",
            [5] = "Mammoth-Mammoth",
            [6] = "Tiger-Tiger",
            [7] = "Gas-Gas",
            [8] = "Yeti-Yeti",
            [9] = "Gravity-Gravity",
            [10] = "Shadow-Shadow",
            [11] = "Venom-Venom",
            [12] = "Control-Control",
            [13] = "Spirit-Spirit",
        },
        ["IdleCheck"] = 300, -- every (x) seconds if not moving rejoin
    };
    getgenv().user_key = 'shii_shii'
    loadstring(game:HttpGet("https://raw.githubusercontent.com/xQuartyx/QuartyzScript/main/OneClick/BF.lua"))()
end
